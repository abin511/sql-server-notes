/*按月按部门统计员工平均心情指数*/
/*
DECLARE @P4 VARCHAR(512)
SET @P4=''
EXEC MS_P_GT_BLOGEMOTIONBYDEP @MONTH='201209',@DEPIDPATHS='',@COMPANYIDS='',@RETURN=@P4 OUTPUT
SELECT @P4
*/
CREATE PROCEDURE MS_P_GT_BLOGEMOTIONBYDEP
@MONTH CHAR(6) , --201204
@DEPIDPATHS VARCHAR(512),
@COMPANYIDS VARCHAR(256),
@RETURN VARCHAR(512) OUTPUT
AS
SET NOCOUNT ON
	DECLARE @TABLENAME CHAR(22)	SET @TABLENAME = 'MS_T_BLOG_EMOTION_' + LEFT(@MONTH,4) +' WITHE(NOLOCK)'
	DECLARE @DATASQL VARCHAR(2048)
	DECLARE @WHERESQL VARCHAR(2048)
	DECLARE @SQL NVARCHAR(MAX)
	--WHERE
	SET @WHERESQL = ' WHERE BELONGS_TO_MONTH= ' + @MONTH
	IF LEN(@COMPANYIDS) > 0 SET @WHERESQL += ' AND  COMPANYID IN(' + @COMPANYIDS + ')'
	--SAVE NEW DATA
	CREATE TABLE DBO.#DATATABLE([DEPIDPATH] VARCHAR(512),[EMOTION] INT,[BELONGS_TO_DATE] VARCHAR(20))
	
	SET @SQL = ' INSERT INTO #DATATABLE SELECT DEPIDPATH,AVG(EMOTION) AS EMOTION,BELONGS_TO_DATE FROM ('
	--部门查询，需要循环862,863,684,
	DECLARE @DEPID INT
	IF LEN(@DEPIDPATHS) > 0 BEGIN
		WHILE( CHARINDEX(',',@DEPIDPATHS ) > 0) BEGIN
			SET @DEPID = SUBSTRING(@DEPIDPATHS,1,CHARINDEX(',',@DEPIDPATHS)-1)
			SET @SQL += N' SELECT DEPIDPATH,EMOTION,BELONGS_TO_DATE FROM ' + @TABLENAME + @WHERESQL + ' AND DEPIDPATH LIKE ''%,'+ CAST(@DEPID AS VARCHAR(10)) +',%'''
			SET @SQL += N' UNION ALL '
			SET	@DEPIDPATHS	= STUFF(@DEPIDPATHS,1,CHARINDEX(',',@DEPIDPATHS),'')   
		END
		SET @SQL = SUBSTRING(@SQL,0,LEN(@SQL) - 9 )
	END
	ELSE BEGIN
		SET @SQL +=  N' SELECT DEPIDPATH,EMOTION,BELONGS_TO_DATE FROM ' + @TABLENAME + @WHERESQL
	END
	SET @SQL += ') AS A GROUP BY DEPIDPATH,BELONGS_TO_DATE'
	PRINT @SQL
	EXEC(@SQL)
	SELECT @DATASQL = ISNULL(@DATASQL + ',' , '') + '['+BELONGS_TO_DATE+ ']' FROM #DATATABLE GROUP BY BELONGS_TO_DATE
	--日子字段
	--SET @DATASQL = ISNULL(@DATASQL,'[' + @MONTH + '-01]')
	PRINT @DATASQL
	SET @RETURN = REPLACE(@DATASQL,LEFT(@MONTH,4)+'-','')
	--获取统计数据
	EXEC ('SELECT DEPIDPATH,'+@DATASQL+' FROM  (SELECT * FROM #DATATABLE  ) A  PIVOT (SUM(EMOTION) FOR BELONGS_TO_DATE IN (' + @DATASQL + ')) AS TMP DROP TABLE #DATATABLE')
SET NOCOUNT OFF
RETURN
/*
获取当天的员工心情数据插入到统计表，统计表按年分表,10.2开始,每天中午12点运行
SELECT * FROM MS_T_BLOG_EMOTION_2012
EXEC MS_P_IT_BLOGEMOTION
drop table MS_T_BLOG_EMOTION_2012
*/
ALTER PROCEDURE MS_P_IT_BLOGEMOTION
AS
SET NOCOUNT ON
	DECLARE @NOW DATETIME SET @NOW = GETDATE()
	DECLARE @TABLENAME CHAR(22)
	SET @TABLENAME = 'MS_T_BLOG_EMOTION_' + CAST(YEAR(@NOW) AS CHAR(4))
	IF NOT EXISTS (SELECT 0 FROM SYSOBJECTS WITH(NOLOCK) 
		WHERE [ID] = OBJECT_ID( @TABLENAME ) AND OBJECTPROPERTY([ID], N'IsUserTable') = 1 ) BEGIN
		--CREATE TABLE
		EXEC ('SELECT USERID,EMPCODE,USERNAME,EMOTION,DEPIDPATH,COMPANYID,CAST(BELONGS_TO_DATE AS VARCHAR(20)) AS BELONGS_TO_DATE,CAST(BELONGS_TO_DATE AS INT) AS BELONGS_TO_MONTH INTO '+@TABLENAME+' FROM MS_T_BLOG WHERE 1=2')																  	
	END
	--insert data (查询昨天的数据)
	DECLARE @SQL NVARCHAR(1024)
	SET @SQL = N'INSERT INTO ' + @TABLENAME + CHAR(10)
	SET @SQL = @SQL +N' SELECT USERID,EMPCODE,USERNAME,EMOTION,DEPIDPATH,COMPANYID,CONVERT(VARCHAR(100),BELONGS_TO_DATE,23),CAST(CONVERT(CHAR(6),BELONGS_TO_DATE,112) AS INT) '+ CHAR(10)
	SET @SQL = @SQL +N' FROM  MS_T_BLOG ' + CHAR(10)
	SET @SQL = @SQL +N' WHERE DATEDIFF(day,BELONGS_TO_DATE,GETDATE()) = 1'
	PRINT @SQL
	--EXECUTE
	EXECUTE SP_EXECUTESQL @SQL
	
	/*判断是否存在BELONGS_TO_MONTH索引，不存在就创建*/
	IF NOT EXISTS(select 0 from sys.indexes where object_name(object_id)=@TABLENAME and name='MS_I_BLOG_EMOTION_BELONGS_TO_MONTH') BEGIN
		DECLARE @INDEXSQL1 VARCHAR(512)
		SET @INDEXSQL1 =
		'CREATE CLUSTERED INDEX [MS_I_BLOG_EMOTION_BELONGS_TO_MONTH] ON [dbo].['+@TABLENAME+'] 
		(
		[BELONGS_TO_MONTH] ASC
		)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
		'
		EXEC(@INDEXSQL1)
	END
	/*判断是否存在DEPIDPATH索引，不存在就创建*/
	IF NOT EXISTS(select 0 from sys.indexes where object_name(object_id)=@TABLENAME and name='MS_I_BLOG_EMOTION_DEPIDPATH') BEGIN
		DECLARE @INDEXSQL2 VARCHAR(512)
		SET @INDEXSQL2 =
		'CREATE NONCLUSTERED INDEX [MS_I_BLOG_EMOTION_DEPIDPATH] ON [dbo].['+@TABLENAME+']
		(
			[DEPIDPATH] ASC
		)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
		'
		EXEC(@INDEXSQL2)
	END
SET NOCOUNT OFF
RETURN