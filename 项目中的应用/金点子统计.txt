/*金点子饼形图统计
declare @a int
exec MS_P_GT_ADVICESTATISTICSPIE 4,'','','2009-12-29',@a
*/
ALTER PROCEDURE MS_P_GT_ADVICESTATISTICSPIE
@ID INT, 
@STATE VARCHAR(20), --包括的状态值 未字符 -1,2,3[未采纳] 1[采纳] 4[申诉]
@BEGINTIME DATETIME, 
@ENDTIME DATETIME,
@RETURN INT OUTPUT 
AS  
SET NOCOUNT ON 
BEGIN 
	--定义表变量
	DECLARE @TEMP TABLE(ID INT IDENTITY,CID INT,PARENTS VARCHAR(255),CHILD INT,[NAME] VARCHAR(128))
	DECLARE @TEMP1 TABLE(CID INT,PARENTS VARCHAR(255),LASTSTATE INT,ADDTIME DATETIME,LASTMONEY DECIMAL(10,2))
	--查询数据
	IF @ID <= 0 BEGIN
		INSERT INTO @TEMP 
		SELECT [ID],PARENTS+CAST(ID AS VARCHAR(10))+',%',CHILD,[NAME]
		FROM MS_T_CLASS  
		WHERE CATEGORY = 1 AND DEPTH = 1					
	END	ELSE BEGIN
		INSERT INTO @TEMP 
		SELECT [ID],PARENTS+CAST(ID AS VARCHAR(10))+',%',CHILD,[NAME] 
		FROM MS_T_CLASS 
		WHERE PARENTID = @ID
	END
--	SELECT * FROM @TEMP 
		--查询数据
		INSERT INTO @TEMP1
		SELECT C.ID,C.PARENTS,LASTSTATE,ADDTIME,LASTMONEY
		FROM MS_T_ADVICE A, MS_T_CLASS C
		WHERE A.CLASSID = C.ID 
		AND (@BEGINTIME ='' OR @ENDTIME ='' OR A.ADDTIME >= @BEGINTIME AND A.ADDTIME < DATEADD(DAY,+1,CONVERT(DATETIME,@ENDTIME)))
		AND (@STATE = '' OR (CHARINDEX(',' + CAST(LASTSTATE AS VARCHAR(10)) + ',', ',' + @STATE + ',' ) > 0))
		AND EXISTS(SELECT * FROM @TEMP T WHERE C.PARENTS LIKE T.PARENTS OR C.ID = T.CID)
--	SELECT * FROM @TEMP1
		SELECT T.CID,T.[NAME],T.CHILD,
		COUNT(1) AS TOTAL,
		SUM(CASE WHEN LASTSTATE = 1 THEN 1 ELSE 0 END) AS ADOPTION,
		SUM(CASE WHEN LASTSTATE = 4 THEN 1 ELSE 0 END) AS APPEAL,
		SUM(CASE WHEN (LASTSTATE = 1 OR LASTSTATE = 4)  THEN 0 ELSE 1 END) AS UNADOPTION,
		ISNULL(SUM(LASTMONEY),0) AS LASTMONEY
		FROM @TEMP T,@TEMP1 T1 WHERE T1.PARENTS LIKE T.PARENTS OR T.CID = T1.CID
		GROUP BY T.CID,T.[NAME],T.CHILD
--  查询总记录数	
		SET @RETURN = (SELECT COUNT(1) FROM dbo.MS_T_ADVICE(NOLOCK))
END
SET NOCOUNT OFF
/*******************************************/

/*金点子饼形图统计
declare @a int
exec MS_P_GT_ADVICESTATISTICSLINE 0,'4','','2009-12-25',@a
*/
ALTER PROCEDURE MS_P_GT_ADVICESTATISTICSLINE
@ID INT, 
@STATE VARCHAR(20), --包括的状态值 未字符 -1,2,3[未采纳] 1[采纳] 4[申诉]
@BEGINTIME DATETIME, 
@ENDTIME DATETIME,
@RETURN INT OUTPUT
AS  
SET NOCOUNT ON 
--获取统计列表数据 返回table
BEGIN 
	--定义表变量
	DECLARE @TEMP TABLE(ID INT IDENTITY,ADDTIME CHAR(10),TOTAL INT,ADOPTION INT,APPEAL INT,UNADOPTION INT,LASTMONEY DECIMAL(10,2))
	--插入查询数据到表变量
	INSERT INTO @TEMP 
	SELECT CONVERT(CHAR(10),ADDTIME, 23) AS ADDTIME,COUNT(1) AS TOTAL,
	SUM(CASE WHEN LASTSTATE = 1 THEN 1 ELSE 0 END) AS ADOPTION,
	SUM(CASE WHEN LASTSTATE = 4 THEN 1 ELSE 0 END) AS APPEAL,
	SUM(CASE WHEN (LASTSTATE = 1 OR LASTSTATE = 4)  THEN 0 ELSE 1 END) AS UNADOPTION,
	ISNULL(SUM(LASTMONEY),0) AS LASTMONEY 
	FROM dbo.MS_T_ADVICE WITH(NOLOCK) GROUP BY CONVERT(CHAR(10),ADDTIME, 23)

	--获取本年中，第一条金点子的发布日期
	DECLARE @FIRSTADDTIME DATETIME
	SET @FIRSTADDTIME = (SELECT TOP 1 ADDTIME FROM dbo.MS_T_ADVICE WHERE YEAR(ADDTIME) = YEAR(GETDATE()) ORDER BY ADDTIME ASC )
	--从发布第一条金点子时间到昨天之间的天数
	DECLARE @DIFFDAYS INT
	SET @DIFFDAYS = DATEDIFF(DAY,(@FIRSTADDTIME),DATEADD(DAY,-1,CONVERT(DATETIME,GETDATE())))
	--从发布第一条金点子时间到上个月的月数
	DECLARE @DIFFMONTHS INT
	SET @DIFFMONTHS =  DATEDIFF(MONTH,(@FIRSTADDTIME),DATEADD(MONTH,-1,CONVERT(DATETIME,GETDATE())))

	--开始统计数据
	SELECT N'今日' AS DATE, SUM(TOTAL) AS TOTAL, SUM(ADOPTION) AS ADOPTION, SUM(APPEAL) AS APPEAL,SUM(UNADOPTION) AS UNADOPTION,
	SUM(LASTMONEY) AS LASTMONEY FROM @TEMP WHERE ADDTIME >= '2009-12-26' AND ADDTIME < DATEADD(DAY,+1,CONVERT(DATETIME,'2009-12-26'))
	UNION ALL
	SELECT N'昨日' AS DATE, SUM(TOTAL) AS TOTAL, SUM(ADOPTION) AS ADOPTION, SUM(APPEAL) AS APPEAL,SUM(UNADOPTION) AS UNADOPTION,
	SUM(LASTMONEY) AS LASTMONEY FROM @TEMP WHERE ADDTIME >= DATEADD(DAY,-1,CONVERT(DATETIME,'2009-12-26')) AND ADDTIME < '2009-12-26'
	UNION ALL
	SELECT N'每日平均' AS AVGDAY,CEILING(SUM(TOTAL)/@DIFFDAYS )AS TOTAL,CEILING(SUM(ADOPTION)/@DIFFDAYS)AS ADOPTION,
	CEILING(SUM(APPEAL)/@DIFFDAYS)AS APPEAL,CEILING(SUM(UNADOPTION)/@DIFFDAYS)AS UNADOPTION,
	CEILING(SUM(LASTMONEY)/@DIFFDAYS)AS LASTMONEY FROM @TEMP
	UNION ALL
	SELECT N'每月平均' AS AVGMONTH,CEILING(SUM(TOTAL)/@DIFFMONTHS )AS TOTAL,CEILING(SUM(ADOPTION)/@DIFFMONTHS)AS ADOPTION,
	CEILING(SUM(APPEAL)/@DIFFMONTHS)AS APPEAL,CEILING(SUM(UNADOPTION)/@DIFFMONTHS)AS UNADOPTION,
	CEILING(SUM(LASTMONEY)/@DIFFMONTHS)AS LASTMONEY FROM @TEMP
	UNION ALL
	SELECT N'历史最高' AS HISTORYHEIGHT,MAX(TOTAL) AS TOTAL,MAX(ADOPTION) AS ADOPTION,MAX(APPEAL) AS APPEAL,
	MAX(UNADOPTION) AS UNADOPTION,MAX(LASTMONEY) AS LASTMONEY  FROM @TEMP
	UNION ALL
	SELECT N'历史累计' AS HISTORYCOUNT, SUM(TOTAL) AS TOTAL, SUM(ADOPTION) AS ADOPTION, SUM(APPEAL) AS APPEAL,
	SUM(UNADOPTION) AS UNADOPTION,SUM(LASTMONEY) AS LASTMONEY FROM @TEMP
END
--返回金点子趋势图数据
BEGIN
	SELECT A.[NAME],A.[ID] AS CID,
	(SELECT COUNT(1) FROM MS_T_ADVICE AS B WHERE B.CLASSID
		IN(SELECT C.[ID] FROM MS_T_CLASS AS C 
		WHERE (C.PARENTS LIKE A.PARENTS + CAST(A.[ID] AS VARCHAR(10)) + ',%') OR C.[ID] =A.[ID])
		AND  B.ADDTIME >= @BEGINTIME AND B.ADDTIME < DATEADD(DAY,+1,CONVERT(DATETIME,@ENDTIME))
		AND (@STATE = '' OR (CHARINDEX(',' + CAST(B.LASTSTATE AS VARCHAR(10)) + ',', ',' + @STATE + ',' ) > 0))
	) AS TOTAL
	FROM MS_T_CLASS AS A WHERE A.CATEGORY = 1 AND A.DEPTH =1
	SET @RETURN =@@ROWCOUNT
END

SET NOCOUNT OFF
	-- select    CONVERT(VARCHAR(20),ROUND(CONVERT(FLOAT,35)/CONVERT(FLOAT,100)*100,2))+'%'
	
--SELECT classID,CONVERT(CHAR(10),ADDTIME,23) FROM dbo.MS_T_ADVICE